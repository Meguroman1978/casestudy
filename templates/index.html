<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title id="pageTitle">æ´»ç”¨äº‹ä¾‹æ¤œç´¢ãƒ„ãƒ¼ãƒ«</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background: #2d3748;
            min-height: 100vh;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ed8936;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .text-orange-custom {
            color: #ed8936;
        }
        .border-orange-custom {
            border-color: #ed8936;
        }
        .bg-orange-custom {
            background-color: #ed8936;
        }
        .bg-orange-custom:hover {
            background-color: #dd6b20;
        }
        .hover\:text-orange-600:hover {
            color: #dd6b20;
        }

        /* ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã•ã‚ŒãŸãƒ‰ãƒ¡ã‚¤ãƒ³è¡Œ */
        .domain-group-header {
            cursor: pointer;
            background-color: #e0f2fe;
        }
        .domain-group-header:hover {
            background-color: #bae6fd;
        }
        .domain-detail-row {
            display: none;
            background-color: #f0f9ff;
        }
        .domain-detail-row.expanded {
            display: table-row;
        }
        .expand-icon {
            transition: transform 0.2s;
        }
        .expand-icon.expanded {
            transform: rotate(90deg);
        }
        /* ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢çµæœ */
        #categorySearchResults {
            max-width: 66.666667%; /* md:w-2/3 equivalent */
        }
        .search-result-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #e5e7eb;
        }
        .search-result-item:hover {
            background-color: #f3f4f6;
        }
        .search-result-item:last-child {
            border-bottom: none;
        }
        .search-result-hierarchy {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 2px;
        }
        .search-highlight {
            background-color: #fef3c7;
            font-weight: 500;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- è¨€èªè¨­å®šï¼ˆæœ€ä¸Šéƒ¨ï¼‰ -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">
                <span>è¨€èªè¨­å®š (Language Settings)</span>
            </label>
            <select id="languageSelect" class="block w-full md:w-1/3 px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                <option value="ja">Japanese</option>
                <option value="en">English</option>
            </select>
        </div>
        
        <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 border-l-4 border-orange-custom">
            <h1 class="text-3xl font-bold text-orange-custom mb-2" data-lang-key="page_title">æ´»ç”¨äº‹ä¾‹æ¤œç´¢ãƒ„ãƒ¼ãƒ«</h1>
            <div class="text-gray-600 space-y-2">
                <p class="font-semibold" data-lang-key="operation_procedure">æ“ä½œæ‰‹é †:</p>
                <ol class="list-decimal list-inside space-y-1 ml-4">
                    <li><span class="font-medium" data-lang-key="instruction_step1">Sigmaãƒ¬ãƒãƒ¼ãƒˆ<a href="https://app.sigmacomputing.com/firework-data/workbook/NEW_extended_Find-Played-URL-Short-Videos-and-Live-Streams-2eHA8NAfblkA6CUalH2dfl" target="_blank" class="text-orange-custom hover:underline">ã€Œextented_Find Played URL (Short Videos & Live Streams)ã€</a>ã‹ã‚‰ã€ã€ŒTop Video Views per URLã€ã¨ã€ŒTop Live Stream Views per URLã€ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã«ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰</span></li>
                    <li><span class="font-medium" data-lang-key="instruction_step2">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’[ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„</span></li>
                    <li><span class="font-medium" data-lang-key="instruction_step3">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ã¾ãŸã¯æ¥­ç¨®ãƒ»å›½ã‚’é¸æŠã—ã€[æ¤œç´¢]ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„</span></li>
                </ol>
            </div>
        </div>

        <!-- å…¥åŠ›ãƒ•ã‚©ãƒ¼ãƒ  -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4" data-lang-key="data_upload">ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h2>
            
            <!-- è­¦å‘Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ -->
            <div class="mb-4 p-3 bg-red-50 border-l-4 border-red-500 rounded">
                <p class="text-red-700 text-sm font-medium" data-lang-key="data_limit_warning">
                    éå»1æ—¥é–“åˆ†ï¼ˆ2025å¹´1æœˆ1æ—¥ä»¥é™ã®æ—¥ä»˜ï¼‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Sigmaã‹ã‚‰æŠ½å‡ºã—ã€ä»¥ä¸‹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„
                </p>
            </div>
            
            <form id="uploadForm" class="space-y-4">
                <!-- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="video_file">Top Video Views per URL (ã‚·ãƒ§ãƒ¼ãƒˆå‹•ç”»)</span>
                        </label>
                        <div class="relative">
                            <input type="file" id="videoFile" name="video_file" accept=".xlsx,.xls" required
                                   class="hidden">
                            <button type="button" onclick="document.getElementById('videoFile').click()" 
                                    class="px-4 py-2 bg-orange-50 text-orange-700 font-semibold rounded-md hover:bg-orange-100 border border-orange-200">
                                <span data-lang-key="select_file">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                            </button>
                            <span id="videoFileName" class="ml-3 text-sm text-gray-500" data-lang-key="no_file_selected">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="live_file">Top Live Stream Views per URL (ãƒ©ã‚¤ãƒ–é…ä¿¡)</span>
                        </label>
                        <div class="relative">
                            <input type="file" id="liveFile" name="live_file" accept=".xlsx,.xls" required
                                   class="hidden">
                            <button type="button" onclick="document.getElementById('liveFile').click()" 
                                    class="px-4 py-2 bg-orange-50 text-orange-700 font-semibold rounded-md hover:bg-orange-100 border border-orange-200">
                                <span data-lang-key="select_file">ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</span>
                            </button>
                            <span id="liveFileName" class="ml-3 text-sm text-gray-500" data-lang-key="no_file_selected">é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“</span>
                        </div>
                    </div>
                </div>

                <!-- ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label for="caseType" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="case_type">äº‹ä¾‹ã‚¿ã‚¤ãƒ—</span> <span class="text-red-500">*</span>
                        </label>
                        <select id="caseType" name="case_type" required
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                            <option value="short_video" data-lang-key="short_video">ã‚·ãƒ§ãƒ¼ãƒˆå‹•ç”»äº‹ä¾‹</option>
                            <option value="live_stream" data-lang-key="live_stream">ãƒ©ã‚¤ãƒ–é…ä¿¡äº‹ä¾‹</option>
                        </select>
                    </div>
                    <div>
                        <label for="country" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="country">å›½</span>
                        </label>
                        <select id="country" name="country"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                            <option value="none" data-lang-key="not_selected">é¸æŠã—ãªã„</option>
                        </select>
                    </div>
                    
                    <!-- Fireworkãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé¸æŠ -->
                    <div>
                        <label for="formatFilter" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="format">ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ</span>
                        </label>
                        <select id="formatFilter" name="format_filter"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                            <option value="é¸æŠã—ãªã„" data-lang-key="not_selected">é¸æŠã—ãªã„</option>
                            <option value="Horizontal Carousel">Horizontal Carousel</option>
                            <option value="Dynamic Carousel">Dynamic Carousel</option>
                            <option value="Carousel">Carousel</option>
                            <option value="Grid">Grid</option>
                            <option value="Story Block">Story Block</option>
                            <option value="Circle Stories">Circle Stories</option>
                            <option value="Vertical Stories">Vertical Stories</option>
                            <option value="Floating Player">Floating Player</option>
                            <option value="Horizontal Player">Horizontal Player</option>
                            <option value="Hero Unit">Hero Unit</option>
                            <option value="Player Deck">Player Deck</option>
                        </select>
                    </div>
                </div>
                
                <!-- ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ -->
                <div class="mb-4">
                    <label for="categorySearch" class="block text-sm font-medium text-gray-700 mb-2">
                        <span data-lang-key="search_category">ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢</span>
                    </label>
                    <div class="relative">
                        <input type="text" id="categorySearch" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªå¯¾å¿œï¼‰"
                               class="block w-full px-3 py-2 pr-10 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom"
                               autocomplete="off">
                        <svg class="absolute right-3 top-3 h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </div>
                    <!-- æ¤œç´¢çµæœã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ -->
                    <div id="categorySearchResults" class="hidden absolute z-10 w-full md:w-2/3 mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                    </div>
                </div>

                <!-- æ¥­ç¨®éšå±¤ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label for="majorCategory" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="major_category">å¤§åˆ†é¡</span>
                        </label>
                        <select id="majorCategory"
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                            <option value="" data-lang-key="not_selected">é¸æŠã—ãªã„</option>
                        </select>
                    </div>
                    <div>
                        <label for="mediumCategory" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="medium_category">ä¸­åˆ†é¡</span>
                        </label>
                        <select id="mediumCategory" disabled
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="" data-lang-key="select_major">å¤§åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                    <div>
                        <label for="smallCategory" class="block text-sm font-medium text-gray-700 mb-2">
                            <span data-lang-key="small_category">å°åˆ†é¡</span>
                        </label>
                        <select id="smallCategory" disabled
                                class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom disabled:bg-gray-100 disabled:cursor-not-allowed">
                            <option value="" data-lang-key="select_medium">ä¸­åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
                        </select>
                    </div>
                </div>

                <!-- é€ä¿¡ãƒœã‚¿ãƒ³ + ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ -->
                <div class="flex justify-end gap-3">
                    <!-- ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ï¼ˆæ¤œç´¢ä¸­ã®ã¿è¡¨ç¤ºï¼‰ -->
                    <button type="button" id="cancelBtn"
                            class="hidden px-6 py-2 bg-red-500 text-white font-semibold rounded-md shadow hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-offset-2">
                        <span data-lang-key="cancel_button">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</span>
                    </button>
                    <!-- æ¤œç´¢ãƒœã‚¿ãƒ³ -->
                    <button type="submit" id="submitBtn"
                            class="px-6 py-2 bg-orange-custom text-white font-semibold rounded-md shadow hover:bg-orange-custom focus:outline-none focus:ring-2 focus:ring-orange-custom focus:ring-offset-2">
                        <span data-lang-key="search_button">æ¤œç´¢</span>
                    </button>
                </div>
            </form>
        </div>

        <!-- ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º -->
        <div id="loading" class="hidden bg-white rounded-lg shadow-md p-8 mb-6">
            <div class="flex flex-col items-center justify-center">
                <div class="loader mb-4"></div>
                <p class="text-gray-600" data-lang-key="processing">ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...</p>
            </div>
        </div>

        <!-- ã‚¨ãƒ©ãƒ¼è¡¨ç¤º -->
        <div id="error" class="hidden bg-red-50 border border-red-200 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-red-600 mt-0.5 mr-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                <div>
                    <h3 class="text-red-800 font-semibold" data-lang-key="error_title">ã‚¨ãƒ©ãƒ¼</h3>
                    <p id="errorMessage" class="text-red-700 mt-1"></p>
                </div>
            </div>
        </div>

        <!-- çµæœè¡¨ç¤º -->
        <div id="results" class="hidden bg-white rounded-lg shadow-md p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold text-gray-800" data-lang-key="results_title">åˆ†æçµæœ</h2>
                <div class="flex gap-4 items-center flex-wrap">
                    <!-- ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ -->
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-700" data-lang-key="sort_by">ä¸¦ã³æ›¿ãˆ:</label>
                        <select id="sortMetric" class="px-3 py-1 border border-gray-300 rounded-md shadow-sm text-sm focus:outline-none focus:ring-orange-custom focus:border-orange-custom">
                            <option value="none" data-lang-key="sort_none">ä¸¦ã³æ›¿ãˆãªã—</option>
                            <option value="VIDEO_VIEWS_desc" data-lang-key="sort_views_desc">3ç§’ä»¥ä¸Šå†ç”ŸUUæ•°ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="VIDEO_VIEWS_asc" data-lang-key="sort_views_asc">3ç§’ä»¥ä¸Šå†ç”ŸUUæ•°ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="VIEWTHROUGH_RATE_desc" data-lang-key="sort_vtr_desc">ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="VIEWTHROUGH_RATE_asc" data-lang-key="sort_vtr_asc">ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="CLICKTHROUGH_RATE_desc" data-lang-key="sort_ctr_desc">CTAã‚¯ãƒªãƒƒã‚¯UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="CLICKTHROUGH_RATE_asc" data-lang-key="sort_ctr_asc">CTAã‚¯ãƒªãƒƒã‚¯UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="A2C_RATE_desc" data-lang-key="sort_a2c_desc">ã‚«ãƒ¼ãƒˆè¿½åŠ UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="A2C_RATE_asc" data-lang-key="sort_a2c_asc">ã‚«ãƒ¼ãƒˆè¿½åŠ UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="COMPLETION_RATE_25P_desc" data-lang-key="sort_cr25_desc">è¦–è´å®Œäº†ç‡25%UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="COMPLETION_RATE_25P_asc" data-lang-key="sort_cr25_asc">è¦–è´å®Œäº†ç‡25%UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="COMPLETION_RATE_50P_desc" data-lang-key="sort_cr50_desc">è¦–è´å®Œäº†ç‡50%UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="COMPLETION_RATE_50P_asc" data-lang-key="sort_cr50_asc">è¦–è´å®Œäº†ç‡50%UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="COMPLETION_RATE_75P_desc" data-lang-key="sort_cr75_desc">è¦–è´å®Œäº†ç‡75%UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="COMPLETION_RATE_75P_asc" data-lang-key="sort_cr75_asc">è¦–è´å®Œäº†ç‡75%UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                            <option value="COMPLETION_RATE_100P_desc" data-lang-key="sort_cr100_desc">è¦–è´å®Œäº†ç‡100%UUç‡ï¼ˆé«˜â†’ä½ï¼‰</option>
                            <option value="COMPLETION_RATE_100P_asc" data-lang-key="sort_cr100_asc">è¦–è´å®Œäº†ç‡100%UUç‡ï¼ˆä½â†’é«˜ï¼‰</option>
                        </select>
                    </div>
                    
                    <label class="flex items-center text-sm text-gray-700">
                        <input type="checkbox" id="groupByDomain" class="mr-2">
                        <span data-lang-key="group_by_domain">ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</span>
                    </label>
                    <span id="resultCount" class="text-sm text-gray-600"></span>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-xs">
                    <thead class="bg-gray-50">
                        <tr id="tableHeader"></tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="tableBody"></tbody>
                </table>
            </div>

            <!-- ãƒœã‚¿ãƒ³ç¾¤ -->
            <div class="mt-4 flex justify-between items-center gap-4">
                <div class="flex gap-2">
                    <button id="downloadCsvBtn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <span data-lang-key="download_csv">CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </button>
                    <button id="downloadExcelBtn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-md shadow hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2">
                        <span data-lang-key="download_excel">Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</span>
                    </button>
                    <button id="loadMoreBtn" class="px-4 py-2 bg-orange-custom text-white font-semibold rounded-md shadow hover:bg-orange-custom focus:outline-none focus:ring-2 focus:ring-orange-custom focus:ring-offset-2 hidden">
                        <span data-lang-key="next_10_sites">æ¬¡ã®10ä»¶ã‚’è¦‹ã‚‹</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentData = null;
        let currentGroupedData = null;
        let currentPage = 1;
        let currentFormData = null;
        let hasNextPage = false;
        let categoryHierarchy = null;
        let categoryMapping = {};  // çµ±åˆå¾Œã®å°åˆ†é¡ â†’ å…ƒã®å°åˆ†é¡ã®ãƒªã‚¹ãƒˆ
        let currentLanguage = 'ja';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ—¥æœ¬èª
        let abortController = null;  // ğŸ†• æ¤œç´¢ã‚­ãƒ£ãƒ³ã‚»ãƒ«ç”¨ã®AbortController
        
        // è¨€èªåˆ‡ã‚Šæ›¿ãˆç”¨ã®ç¿»è¨³ãƒ†ã‚­ã‚¹ãƒˆ
        const translations = {
            page_title: { ja: 'æ´»ç”¨äº‹ä¾‹æ¤œç´¢ãƒ„ãƒ¼ãƒ«', en: 'Use Case Search Tool' },
            language_settings: { ja: 'è¨€èªè¨­å®š', en: 'Language Settings' },
            data_upload: { ja: 'ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰', en: 'Data Upload' },
            video_file: { ja: 'Top Video Views per URL (ã‚·ãƒ§ãƒ¼ãƒˆå‹•ç”»)', en: 'Top Video Views per URL (Short Videos)' },
            live_file: { ja: 'Top Live Stream Views per URL (ãƒ©ã‚¤ãƒ–é…ä¿¡)', en: 'Top Live Stream Views per URL (Live Streams)' },
            case_type: { ja: 'äº‹ä¾‹ã‚¿ã‚¤ãƒ—', en: 'Case Type' },
            short_video: { ja: 'ã‚·ãƒ§ãƒ¼ãƒˆå‹•ç”»äº‹ä¾‹', en: 'Short Video Cases' },
            live_stream: { ja: 'ãƒ©ã‚¤ãƒ–é…ä¿¡äº‹ä¾‹', en: 'Live Stream Cases' },
            country: { ja: 'å›½', en: 'Country' },
            format: { ja: 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ', en: 'Format' },
            not_selected: { ja: 'é¸æŠã—ãªã„', en: 'Not Selected' },
            other_country: { ja: 'ãã®ä»–', en: 'Other' },
            search_category: { ja: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢', en: 'Search Category' },
            search_placeholder: { ja: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ï¼ˆæ—¥æœ¬èªãƒ»è‹±èªå¯¾å¿œï¼‰', en: 'Search by keyword (Japanese/English)' },
            major_category: { ja: 'å¤§åˆ†é¡', en: 'Major Category' },
            medium_category: { ja: 'ä¸­åˆ†é¡', en: 'Medium Category' },
            small_category: { ja: 'å°åˆ†é¡', en: 'Small Category' },
            select_major: { ja: 'å¤§åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„', en: 'Select Major Category' },
            select_medium: { ja: 'ä¸­åˆ†é¡ã‚’é¸æŠã—ã¦ãã ã•ã„', en: 'Select Medium Category' },
            search_button: { ja: 'æ¤œç´¢', en: 'Search' },
            cancel_button: { ja: 'ã‚­ãƒ£ãƒ³ã‚»ãƒ«', en: 'Cancel' },
            processing: { ja: 'ãƒ‡ãƒ¼ã‚¿ã‚’å‡¦ç†ä¸­...', en: 'Processing data...' },
            error_title: { ja: 'ã‚¨ãƒ©ãƒ¼', en: 'Error' },
            results_title: { ja: 'çµæœ', en: 'Results' },
            sort_by: { ja: 'ä¸¦ã³æ›¿ãˆ', en: 'Sort by' },
            sort_none: { ja: 'ä¸¦ã³æ›¿ãˆãªã—', en: 'No sorting' },
            sort_views_desc: { ja: '3ç§’ä»¥ä¸Šå†ç”ŸUUæ•°ï¼ˆé«˜â†’ä½ï¼‰', en: '3s+ Video Views UU (Highâ†’Low)' },
            sort_views_asc: { ja: '3ç§’ä»¥ä¸Šå†ç”ŸUUæ•°ï¼ˆä½â†’é«˜ï¼‰', en: '3s+ Video Views UU (Lowâ†’High)' },
            sort_vtr_desc: { ja: 'ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: 'View-Through UU Rate (Highâ†’Low)' },
            sort_vtr_asc: { ja: 'ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: 'View-Through UU Rate (Lowâ†’High)' },
            sort_ctr_desc: { ja: 'CTAã‚¯ãƒªãƒƒã‚¯UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: 'CTA Click UU Rate (Highâ†’Low)' },
            sort_ctr_asc: { ja: 'CTAã‚¯ãƒªãƒƒã‚¯UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: 'CTA Click UU Rate (Lowâ†’High)' },
            sort_a2c_desc: { ja: 'ã‚«ãƒ¼ãƒˆè¿½åŠ UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: 'Add-to-Cart UU Rate (Highâ†’Low)' },
            sort_a2c_asc: { ja: 'ã‚«ãƒ¼ãƒˆè¿½åŠ UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: 'Add-to-Cart UU Rate (Lowâ†’High)' },
            sort_cr25_desc: { ja: 'è¦–è´å®Œäº†ç‡25%UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: '25% Completion UU Rate (Highâ†’Low)' },
            sort_cr25_asc: { ja: 'è¦–è´å®Œäº†ç‡25%UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: '25% Completion UU Rate (Lowâ†’High)' },
            sort_cr50_desc: { ja: 'è¦–è´å®Œäº†ç‡50%UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: '50% Completion UU Rate (Highâ†’Low)' },
            sort_cr50_asc: { ja: 'è¦–è´å®Œäº†ç‡50%UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: '50% Completion UU Rate (Lowâ†’High)' },
            sort_cr75_desc: { ja: 'è¦–è´å®Œäº†ç‡75%UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: '75% Completion UU Rate (Highâ†’Low)' },
            sort_cr75_asc: { ja: 'è¦–è´å®Œäº†ç‡75%UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: '75% Completion UU Rate (Lowâ†’High)' },
            sort_cr100_desc: { ja: 'è¦–è´å®Œäº†ç‡100%UUç‡ï¼ˆé«˜â†’ä½ï¼‰', en: '100% Completion UU Rate (Highâ†’Low)' },
            sort_cr100_asc: { ja: 'è¦–è´å®Œäº†ç‡100%UUç‡ï¼ˆä½â†’é«˜ï¼‰', en: '100% Completion UU Rate (Lowâ†’High)' },
            group_by_domain: { ja: 'ãƒ‰ãƒ¡ã‚¤ãƒ³ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–', en: 'Group by Domain' },
            load_more: { ja: 'æ¬¡ã®10ä»¶ã‚’è¦‹ã‚‹', en: 'Show Next 10' },
            download_csv: { ja: 'CSVã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', en: 'Download CSV' },
            channel_name: { ja: 'ãƒãƒ£ãƒ³ãƒãƒ«å', en: 'Channel Name' },
            industry: { ja: 'æ¥­ç¨®', en: 'Industry' },
            country_col: { ja: 'å›½', en: 'Country' },
            url_col: { ja: 'URL', en: 'URL' },
            results_found: { ja: 'ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ', en: 'results found' },
            total_domains: { ja: 'å…¨', en: '' },
            domains_suffix: { ja: 'ãƒ‰ãƒ¡ã‚¤ãƒ³', en: 'total domains' },
            no_results: { ja: 'è©²å½“ã™ã‚‹ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', en: 'No matching categories found' },
            operation_procedure: { ja: 'æ“ä½œæ‰‹é †:', en: 'How to use this tool:' },
            instruction_step1: { 
                ja: 'Sigmaãƒ¬ãƒãƒ¼ãƒˆ<a href="https://app.sigmacomputing.com/firework-data/workbook/NEW_extended_Find-Played-URL-Short-Videos-and-Live-Streams-2eHA8NAfblkA6CUalH2dfl" target="_blank" class="text-orange-custom hover:underline">ã€Œextented_Find Played URL (Short Videos & Live Streams)ã€</a>ã‹ã‚‰ã€ã€ŒTop Video Views per URLã€ã¨ã€ŒTop Live Stream Views per URLã€ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ï¼ˆãƒ‡ãƒ¼ã‚¿ã®è¡¨ç¤ºã«ã¯æ•°åˆ†ã‹ã‹ã‚Šã¾ã™ï¼‰', 
                en: 'Download the <a href="https://app.sigmacomputing.com/firework-data/workbook/NEW_extended_Find-Played-URL-Short-Videos-and-Live-Streams-2eHA8NAfblkA6CUalH2dfl" target="_blank" class="text-orange-custom hover:underline">"extented_Find Played URL (Short Videos & Live Streams)"</a> Sigma report, specifically the "Top Video Views per URL" and "Top Live Stream Views per URL" reports (data may take a few minutes to load)' 
            },
            instruction_step2: { 
                ja: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’[ãƒ‡ãƒ¼ã‚¿ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰]ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 
                en: 'Upload the downloaded data to the [Data Upload] section' 
            },
            instruction_step3: { 
                ja: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ã¾ãŸã¯æ¥­ç¨®ãƒ»å›½ã‚’é¸æŠã—ã€[æ¤œç´¢]ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„', 
                en: 'Use category search or select industry and country, then click the [Search] button' 
            },
            select_file: { ja: 'ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ', en: 'Select data file' },
            no_file_selected: { ja: 'é¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“', en: 'No data file is selected' },
            data_limit_warning: { 
                ja: 'éå»1æ—¥é–“åˆ†ï¼ˆ2025å¹´1æœˆ1æ—¥ä»¥é™ã®æ—¥ä»˜ï¼‰ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’Sigmaã‹ã‚‰æŠ½å‡ºã—ã€ä»¥ä¸‹ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„', 
                en: 'Please extract and upload global data from Sigma for the past 1 day (dates after January 1, 2025)' 
            },
            download_format: { ja: 'ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å½¢å¼', en: 'Download Format' },
            download_csv: { ja: 'CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', en: 'Download CSV' },
            download_excel: { ja: 'Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰', en: 'Download Excel' },
            next_10_sites: { ja: 'æ¬¡ã®10ä»¶ã‚’è¦‹ã‚‹', en: 'Next 10 Sites' },
            create_slide: { ja: 'ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆ', en: 'Create Slide' }
        };
        
        // è¨€èªã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹é–¢æ•°
        function switchLanguage(lang) {
            currentLanguage = lang;
            
            // ãƒšãƒ¼ã‚¸ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆ<title>ã‚¿ã‚°ï¼‰ã‚’æ›´æ–°
            const titleElement = document.getElementById('pageTitle');
            if (titleElement && translations.page_title && translations.page_title[lang]) {
                titleElement.textContent = translations.page_title[lang];
            }
            
            // data-lang-keyå±æ€§ã‚’æŒã¤å…¨è¦ç´ ã‚’æ›´æ–°
            document.querySelectorAll('[data-lang-key]').forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[key] && translations[key][lang]) {
                    // HTMLã‚’å«ã‚€å ´åˆã¯innerHTMLã‚’ä½¿ç”¨ã€ãã‚Œä»¥å¤–ã¯textContentã‚’ä½¿ç”¨
                    if (translations[key][lang].includes('<')) {
                        el.innerHTML = translations[key][lang];
                    } else {
                        el.textContent = translations[key][lang];
                    }
                }
            });
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’æ›´æ–°
            const searchInput = document.getElementById('categorySearch');
            if (searchInput) {
                searchInput.placeholder = translations.search_placeholder[lang];
            }
            
            // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’æ›´æ–°ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ä»¥å¤–ï¼‰
            updateDropdownOptions();
            
            // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            updateFileInputLabels(lang);
            
            // çµæœãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å†æç”»
            if (currentData) {
                displayResults(currentData, false);
            }
            
            // ğŸ†• å›½ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’è¨€èªã«å¿œã˜ã¦è¨­å®š
            const countrySelect = document.getElementById('country');
            if (countrySelect) {
                if (lang === 'ja') {
                    // æ—¥æœ¬èªã®å ´åˆã€Japanã‚’é¸æŠ
                    const japanOption = Array.from(countrySelect.options).find(opt => opt.value === 'Japan');
                    if (japanOption) {
                        countrySelect.value = 'Japan';
                    }
                } else if (lang === 'en') {
                    // è‹±èªã®å ´åˆã€Americasã‚’é¸æŠ
                    const americasOption = Array.from(countrySelect.options).find(opt => opt.value === 'Americas');
                    if (americasOption) {
                        countrySelect.value = 'Americas';
                    }
                }
            }
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒœã‚¿ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function updateFileInputLabels(lang) {
            // ãƒ•ã‚¡ã‚¤ãƒ«åè¡¨ç¤ºã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ï¼‰
            const videoFile = document.getElementById('videoFile');
            const liveFile = document.getElementById('liveFile');
            const videoFileName = document.getElementById('videoFileName');
            const liveFileName = document.getElementById('liveFileName');
            
            // ãƒ•ã‚¡ã‚¤ãƒ«ãŒé¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆã®ã¿ã€ã€Œé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€ãƒ†ã‚­ã‚¹ãƒˆã‚’æ›´æ–°
            if (!videoFile.files || videoFile.files.length === 0) {
                if (videoFileName.hasAttribute('data-lang-key')) {
                    videoFileName.textContent = translations.no_file_selected[lang];
                }
            }
            
            if (!liveFile.files || liveFile.files.length === 0) {
                if (liveFileName.hasAttribute('data-lang-key')) {
                    liveFileName.textContent = translations.no_file_selected[lang];
                }
            }
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢æ©Ÿèƒ½
        function searchCategories(query) {
            if (!categoryHierarchy || !query || query.trim().length === 0) {
                return [];
            }
            
            const results = [];
            const lowerQuery = query.toLowerCase().trim();
            
            // å…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’æ¤œç´¢
            for (const major in categoryHierarchy) {
                for (const medium in categoryHierarchy[major]) {
                    for (const small in categoryHierarchy[major][medium]) {
                        // æ—¥æœ¬èªã¨è‹±èªã®ä¸¡æ–¹ã§æ¤œç´¢
                        const searchText = `${major} ${medium} ${small}`.toLowerCase();
                        
                        if (searchText.includes(lowerQuery)) {
                            results.push({
                                major: major,
                                medium: medium,
                                small: small,
                                matchText: small
                            });
                        }
                    }
                }
            }
            
            return results;
        }
        
        // æ¤œç´¢çµæœã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º
        function highlightMatch(text, query) {
            if (!query || query.trim().length === 0) {
                return text;
            }
            
            const lowerText = text.toLowerCase();
            const lowerQuery = query.toLowerCase().trim();
            const index = lowerText.indexOf(lowerQuery);
            
            if (index === -1) {
                return text;
            }
            
            const before = text.substring(0, index);
            const match = text.substring(index, index + query.length);
            const after = text.substring(index + query.length);
            
            return `${before}<span class="search-highlight">${match}</span>${after}`;
        }
        
        // æ¤œç´¢çµæœã‚’è¡¨ç¤º
        function displaySearchResults(results, query) {
            const resultsContainer = document.getElementById('categorySearchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = `
                    <div class="search-result-item text-gray-500 text-center">
                        ${translations.no_results[currentLanguage]}
                    </div>
                `;
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = '';
            
            results.forEach(result => {
                const item = document.createElement('div');
                item.className = 'search-result-item';
                
                // å°åˆ†é¡ã‚’è¨€èªã«å¿œã˜ã¦è¡¨ç¤º
                const smallText = extractLanguageText(result.small, currentLanguage);
                const majorText = extractLanguageText(result.major, currentLanguage);
                const mediumText = extractLanguageText(result.medium, currentLanguage);
                
                item.innerHTML = `
                    <div class="font-medium">${highlightMatch(smallText, query)}</div>
                    <div class="search-result-hierarchy">
                        ${majorText} > ${mediumText}
                    </div>
                `;
                
                // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼šã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è‡ªå‹•é¸æŠ
                item.addEventListener('click', () => {
                    selectCategory(result.major, result.medium, result.small);
                    resultsContainer.classList.add('hidden');
                    document.getElementById('categorySearch').value = smallText;
                });
                
                resultsContainer.appendChild(item);
            });
            
            resultsContainer.classList.remove('hidden');
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è‡ªå‹•é¸æŠ
        function selectCategory(major, medium, small) {
            // å¤§åˆ†é¡ã‚’é¸æŠ
            const majorSelect = document.getElementById('majorCategory');
            majorSelect.value = major;
            majorSelect.dispatchEvent(new Event('change'));
            
            // ä¸­åˆ†é¡ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
            setTimeout(() => {
                const mediumSelect = document.getElementById('mediumCategory');
                
                // ä¸­åˆ†é¡ã‚’é¸æŠï¼ˆå…ƒã®ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¢ã™ï¼‰
                for (let option of mediumSelect.options) {
                    const originalText = option.getAttribute('data-original-text') || option.value;
                    if (originalText === medium) {
                        mediumSelect.value = option.value;
                        mediumSelect.dispatchEvent(new Event('change'));
                        break;
                    }
                }
                
                // å°åˆ†é¡ãŒèª­ã¿è¾¼ã¾ã‚Œã‚‹ã¾ã§å¾…ã¤
                setTimeout(() => {
                    const smallSelect = document.getElementById('smallCategory');
                    
                    // å°åˆ†é¡ã‚’é¸æŠ
                    for (let option of smallSelect.options) {
                        const originalText = option.getAttribute('data-original-text') || option.value;
                        if (originalText === small) {
                            smallSelect.value = option.value;
                            break;
                        }
                    }
                }, 100);
            }, 100);
        }
        
        // ãƒã‚¤ãƒªãƒ³ã‚¬ãƒ«ãƒ†ã‚­ã‚¹ãƒˆã‹ã‚‰è¨€èªåˆ¥ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ½å‡º
        function extractLanguageText(text, lang) {
            if (!text) return text;
            
            // "æ—¥æœ¬èª / English" å½¢å¼ã®å ´åˆ
            if (text.includes(' / ')) {
                const parts = text.split(' / ');
                return lang === 'ja' ? parts[0].trim() : parts[1].trim();
            }
            
            return text;
        }
        
        // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®é¸æŠè‚¢ã‚’æ›´æ–°
        function updateDropdownOptions() {
            // å›½ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            const countrySelect = document.getElementById('country');
            Array.from(countrySelect.options).forEach(option => {
                const originalText = option.getAttribute('data-original-text') || option.textContent;
                if (!option.getAttribute('data-original-text')) {
                    option.setAttribute('data-original-text', originalText);
                }
                
                // "System"ã‚’"ãã®ä»–"ã¨ã—ã¦è¡¨ç¤º
                if (option.value === 'System') {
                    option.textContent = currentLanguage === 'ja' ? 'ãã®ä»–' : 'Other';
                } else if (option.value === 'none') {
                    option.textContent = translations.not_selected[currentLanguage];
                } else {
                    option.textContent = extractLanguageText(originalText, currentLanguage);
                }
            });
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
            updateCategoryDropdowns();
        }
        
        // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’æ›´æ–°
        function updateCategoryDropdowns() {
            ['majorCategory', 'mediumCategory', 'smallCategory'].forEach(selectId => {
                const select = document.getElementById(selectId);
                Array.from(select.options).forEach(option => {
                    const originalText = option.getAttribute('data-original-text') || option.textContent;
                    if (!option.getAttribute('data-original-text')) {
                        option.setAttribute('data-original-text', originalText);
                    }
                    
                    if (option.value === '') {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
                        const key = selectId === 'majorCategory' ? 'not_selected' :
                                    selectId === 'mediumCategory' ? 'select_major' : 'select_medium';
                        option.textContent = translations[key][currentLanguage];
                    } else {
                        option.textContent = extractLanguageText(originalText, currentLanguage);
                    }
                });
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«å›½ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¨ã‚«ãƒ†ã‚´ãƒªãƒ¼éšå±¤ã‚’å–å¾—
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // è¨€èªåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                document.getElementById('languageSelect').addEventListener('change', function() {
                    switchLanguage(this.value);
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ™‚ã«ãƒ•ã‚¡ã‚¤ãƒ«åã‚’è¡¨ç¤º
                document.getElementById('videoFile').addEventListener('change', function(e) {
                    const fileName = e.target.files[0] ? e.target.files[0].name : translations.no_file_selected[currentLanguage];
                    document.getElementById('videoFileName').textContent = fileName;
                    document.getElementById('videoFileName').removeAttribute('data-lang-key');
                });
                
                document.getElementById('liveFile').addEventListener('change', function(e) {
                    const fileName = e.target.files[0] ? e.target.files[0].name : translations.no_file_selected[currentLanguage];
                    document.getElementById('liveFileName').textContent = fileName;
                    document.getElementById('liveFileName').removeAttribute('data-lang-key');
                });
                
                // å›½ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’å–å¾—
                const optionsResponse = await fetch('/api/get-options');
                const optionsData = await optionsResponse.json();
                
                if (optionsResponse.ok) {
                    const countrySelect = document.getElementById('country');
                    
                    // å›½ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                    optionsData.countries.forEach(country => {
                        const option = document.createElement('option');
                        option.value = country;
                        // "System"ã‚’"ãã®ä»–"ã¨ã—ã¦è¡¨ç¤ºï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§ã¯Systemã‚’ä½¿ç”¨ï¼‰
                        if (country === 'System') {
                            option.textContent = 'ãã®ä»– / Other';
                            option.setAttribute('data-original-text', 'ãã®ä»– / Other');
                        } else {
                            option.textContent = country;
                            option.setAttribute('data-original-text', country);
                        }
                        countrySelect.appendChild(option);
                    });
                    
                    // åˆæœŸè¨€èªã‚’é©ç”¨
                    switchLanguage('ja');
                } else {
                    showError('ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ / Failed to load options: ' + optionsData.error);
                }
                
                // ã‚«ãƒ†ã‚´ãƒªãƒ¼éšå±¤ã‚’å–å¾—
                const categoryResponse = await fetch('/api/get-category-hierarchy');
                categoryHierarchy = await categoryResponse.json();
                
                if (categoryResponse.ok) {
                    // å¤§åˆ†é¡ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                    const majorSelect = document.getElementById('majorCategory');
                    Object.keys(categoryHierarchy).forEach(major => {
                        const option = document.createElement('option');
                        option.value = major;
                        option.textContent = major;
                        option.setAttribute('data-original-text', major);
                        majorSelect.appendChild(option);
                    });
                    
                    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒãƒƒãƒ”ãƒ³ã‚°ã‚’ä½œæˆ
                    for (const major in categoryHierarchy) {
                        for (const medium in categoryHierarchy[major]) {
                            for (const smallConsolidated in categoryHierarchy[major][medium]) {
                                const originalSmalls = categoryHierarchy[major][medium][smallConsolidated];
                                categoryMapping[smallConsolidated] = originalSmalls;
                            }
                        }
                    }
                    
                    // åˆæœŸè¨€èªã‚’é©ç”¨
                    switchLanguage('ja');
                } else {
                    showError('ã‚«ãƒ†ã‚´ãƒªãƒ¼éšå±¤ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ / Failed to load category hierarchy');
                }
            } catch (error) {
                showError('åˆæœŸåŒ–ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ / Error during initialization: ' + error.message);
            }
            
            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã¯å¸¸ã«ã‚ªãƒ³ã«è¨­å®šã—ã€éè¡¨ç¤ºã«
            const groupByCheckbox = document.getElementById('groupByDomain');
            groupByCheckbox.checked = true;
            groupByCheckbox.parentElement.style.display = 'none';
            
            // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('sortMetric').addEventListener('change', function() {
                if (currentData) {
                    applySortAndDisplay();
                }
            });
            
            // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ï¼ˆå¿µã®ãŸã‚ï¼‰
            groupByCheckbox.addEventListener('change', function() {
                if (currentData) {
                    applySortAndDisplay();
                }
            });
            
            // ã‚«ãƒ†ã‚´ãƒªãƒ¼æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            const categorySearchInput = document.getElementById('categorySearch');
            const categorySearchResults = document.getElementById('categorySearchResults');
            
            categorySearchInput.addEventListener('input', function(e) {
                const query = e.target.value;
                
                if (query.trim().length === 0) {
                    categorySearchResults.classList.add('hidden');
                    return;
                }
                
                const results = searchCategories(query);
                displaySearchResults(results, query);
            });
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰çµæœã‚’éè¡¨ç¤º
            document.addEventListener('click', function(e) {
                if (!categorySearchInput.contains(e.target) && !categorySearchResults.contains(e.target)) {
                    categorySearchResults.classList.add('hidden');
                }
            });
            
            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ãŸã‚‰çµæœã‚’å†è¡¨ç¤ºï¼ˆå‰å›ã®æ¤œç´¢çµæœãŒã‚ã‚‹å ´åˆï¼‰
            categorySearchInput.addEventListener('focus', function() {
                if (this.value.trim().length > 0 && categorySearchResults.children.length > 0) {
                    categorySearchResults.classList.remove('hidden');
                }
            });
            
            // å¤§åˆ†é¡é¸æŠæ™‚
            document.getElementById('majorCategory').addEventListener('change', function() {
            const selectedMajor = this.value;
            const mediumSelect = document.getElementById('mediumCategory');
            const smallSelect = document.getElementById('smallCategory');
            
            // ä¸­åˆ†é¡ã¨å°åˆ†é¡ã‚’ãƒªã‚»ãƒƒãƒˆ
            const mediumDefaultText = translations.select_major[currentLanguage];
            const smallDefaultText = translations.select_medium[currentLanguage];
            mediumSelect.innerHTML = `<option value="" data-lang-key="select_major">${mediumDefaultText}</option>`;
            smallSelect.innerHTML = `<option value="" data-lang-key="select_medium">${smallDefaultText}</option>`;
            smallSelect.disabled = true;
            
            if (selectedMajor) {
                // ä¸­åˆ†é¡ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                mediumSelect.disabled = false;
                Object.keys(categoryHierarchy[selectedMajor]).forEach(medium => {
                    const option = document.createElement('option');
                    option.value = medium;
                    option.textContent = extractLanguageText(medium, currentLanguage);
                    option.setAttribute('data-original-text', medium);
                    mediumSelect.appendChild(option);
                });
            } else {
                mediumSelect.disabled = true;
            }
            });
            
            // ä¸­åˆ†é¡é¸æŠæ™‚
            document.getElementById('mediumCategory').addEventListener('change', function() {
            const selectedMajor = document.getElementById('majorCategory').value;
            const selectedMedium = this.options[this.selectedIndex].getAttribute('data-original-text') || this.value;
            const smallSelect = document.getElementById('smallCategory');
            
            // å°åˆ†é¡ã‚’ãƒªã‚»ãƒƒãƒˆ
            const defaultText = translations.not_selected[currentLanguage];
            smallSelect.innerHTML = `<option value="" data-lang-key="not_selected">${defaultText}</option>`;
            
            if (selectedMajor && selectedMedium) {
                // å°åˆ†é¡ã®ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
                smallSelect.disabled = false;
                Object.keys(categoryHierarchy[selectedMajor][selectedMedium]).forEach(small => {
                    const option = document.createElement('option');
                    option.value = small;
                    option.textContent = extractLanguageText(small, currentLanguage);
                    option.setAttribute('data-original-text', small);
                    smallSelect.appendChild(option);
                });
            } else {
                smallSelect.disabled = true;
            }
            });

            // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // æ—¢å­˜ã®æ¤œç´¢ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
            if (abortController) {
                abortController.abort();
            }
            
            // æ–°ã—ã„AbortControllerã‚’ä½œæˆ
            abortController = new AbortController();
            
            // ãƒšãƒ¼ã‚¸ã‚’ãƒªã‚»ãƒƒãƒˆ
            currentPage = 1;
            currentFormData = new FormData(e.target);
            
            // UIæ›´æ–°
            hideError();
            hideResults();
            showLoading();
            
            // ğŸ†• æ¤œç´¢ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤ºã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('submitBtn').classList.add('hidden');
            document.getElementById('cancelBtn').classList.remove('hidden');
            
            try {
                await loadData(currentPage);
            } finally {
                // ğŸ†• æ¤œç´¢å®Œäº†å¾Œã€ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                document.getElementById('submitBtn').classList.remove('hidden');
                document.getElementById('cancelBtn').classList.add('hidden');
            }
            });
            
            // ğŸ†• ã‚­ãƒ£ãƒ³ã‚»ãƒ«ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('cancelBtn').addEventListener('click', () => {
                if (abortController) {
                    abortController.abort();
                    abortController = null;
                }
                
                // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ã‚’éè¡¨ç¤º
                hideLoading();
                
                // ãƒœã‚¿ãƒ³ã‚’å…ƒã«æˆ»ã™
                document.getElementById('submitBtn').classList.remove('hidden');
                document.getElementById('cancelBtn').classList.add('hidden');
                
                // ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥
                window.location.reload();
            });
            
            // ã€Œæ¬¡ã®10ä»¶ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
            document.getElementById('loadMoreBtn').addEventListener('click', async () => {
                currentPage++;
                showLoading();
                await loadData(currentPage, true);
            });
            
            // CSVãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            document.getElementById('downloadCsvBtn').addEventListener('click', () => {
                if (!currentData) return;
                
                // åˆ—åã‚’ç¾åœ¨ã®è¨€èªã§å–å¾—
                const languageSpecificColumns = currentData.columns.map(col => {
                    if (currentLanguage === 'ja') {
                        return col;
                    } else {
                        // æ—¥æœ¬èªã‚’è‹±èªã«å¤‰æ›
                        const mapping = {
                            'ãƒãƒ£ãƒ³ãƒãƒ«å': 'Channel Name',
                            'æ¥­ç¨®': 'Industry',
                            'å›½': 'Country',
                            'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ': 'Format',
                            'URL': 'URL',
                            'VIDEO_VIEWS': '3s+ Video Views UU',
                            'VIEWTHROUGH_RATE': 'View-Through UU Rate',
                            'CLICKTHROUGH_RATE': 'CTA Click UU Rate',
                            'A2C_RATE': 'Add-to-Cart UU Rate',
                            'COMPLETION_RATE_25P': '25% Completion UU Rate',
                            'COMPLETION_RATE_50P': '50% Completion UU Rate',
                            'COMPLETION_RATE_75P': '75% Completion UU Rate',
                            'COMPLETION_RATE_100P': '100% Completion UU Rate'
                        };
                        return mapping[col] || col;
                    }
                });
                
                // CSVãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆ
                const csv = [];
                csv.push(languageSpecificColumns.join(','));
                
                currentData.data.forEach(row => {
                    const values = currentData.columns.map(col => {
                        const value = row[col] || '';
                        // ã‚«ãƒ³ãƒã‚„æ”¹è¡Œã‚’å«ã‚€å ´åˆã¯ãƒ€ãƒ–ãƒ«ã‚¯ã‚©ãƒ¼ãƒˆã§å›²ã‚€
                        if (value.toString().includes(',') || value.toString().includes('\n')) {
                            return `"${value.toString().replace(/"/g, '""')}"`;
                        }
                        return value;
                    });
                    csv.push(values.join(','));
                });
                
                // BOMã‚’è¿½åŠ ã—ã¦Excelã§æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
                const bom = '\uFEFF';
                const csvContent = bom + csv.join('\n');
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ï¼ˆãƒ•ã‚¡ã‚¤ãƒ«åã‚‚è¨€èªã«å¿œã˜ã¦å¤‰æ›´ï¼‰
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const dateStr = new Date().toISOString().split('T')[0];
                const filename = currentLanguage === 'ja' ? 
                    `åˆ†æçµæœ_${dateStr}.csv` : 
                    `analysis_result_${dateStr}.csv`;
                link.download = filename;
                link.click();
            });
            
            // Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            document.getElementById('downloadExcelBtn').addEventListener('click', async () => {
                if (!currentData) return;
                
                try {
                    showLoading();
                    
                    const response = await fetch('/api/export-excel', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            data: currentData.data,
                            columns: currentData.columns,
                            language: currentLanguage
                        })
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        const dateStr = new Date().toISOString().split('T')[0];
                        const filename = currentLanguage === 'ja' ? 
                            `åˆ†æçµæœ_${dateStr}.xlsx` : 
                            `analysis_result_${dateStr}.xlsx`;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        window.URL.revokeObjectURL(url);
                        document.body.removeChild(a);
                    } else {
                        showError('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼');
                    }
                } catch (error) {
                    showError('Excelã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
                } finally {
                    hideLoading();
                }
            });
        });
        
        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–¢æ•°
        async function loadData(page, append = false) {
            try {
                const formData = new FormData();
                
                // ãƒ•ã‚¡ã‚¤ãƒ«ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼
                if (currentFormData) {
                    for (let [key, value] of currentFormData.entries()) {
                        formData.append(key, value);
                    }
                }
                
                // éšå±¤çš„ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: å¤§åˆ†é¡ãƒ»ä¸­åˆ†é¡ãƒ»å°åˆ†é¡ã®é¸æŠçŠ¶æ…‹ã«åŸºã¥ã„ã¦ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                let selectedMajor = '';
                let selectedMiddle = '';
                let selectedSmall = '';
                
                try {
                    const majorCategoryEl = document.getElementById('majorCategory');
                    const middleCategoryEl = document.getElementById('middleCategory');
                    const smallCategoryEl = document.getElementById('smallCategory');
                    
                    selectedMajor = majorCategoryEl ? (majorCategoryEl.value || '') : '';
                    selectedMiddle = middleCategoryEl ? (middleCategoryEl.value || '') : '';
                    selectedSmall = smallCategoryEl ? (smallCategoryEl.value || '') : '';
                    
                    console.log('Category values:', { selectedMajor, selectedMiddle, selectedSmall });
                } catch (err) {
                    console.error('Error getting category values:', err);
                }
                
                let industriesToFilter = [];
                
                if (selectedSmall && categoryMapping && categoryMapping[selectedSmall]) {
                    // å°åˆ†é¡ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ: è©²å½“ã™ã‚‹å°åˆ†é¡ã®ã¿
                    industriesToFilter = categoryMapping[selectedSmall];
                } else if (selectedMiddle && categoryHierarchy && categoryHierarchy[selectedMajor] && categoryHierarchy[selectedMajor][selectedMiddle]) {
                    // ä¸­åˆ†é¡ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ: è©²å½“ä¸­åˆ†é¡å‚˜ä¸‹ã®ã™ã¹ã¦ã®å°åˆ†é¡
                    const middleCategory = categoryHierarchy[selectedMajor][selectedMiddle];
                    for (const smallKey in middleCategory) {
                        industriesToFilter = industriesToFilter.concat(middleCategory[smallKey]);
                    }
                } else if (selectedMajor && categoryHierarchy && categoryHierarchy[selectedMajor]) {
                    // å¤§åˆ†é¡ã®ã¿é¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆ: è©²å½“å¤§åˆ†é¡å‚˜ä¸‹ã®ã™ã¹ã¦ã®ä¸­å°åˆ†é¡
                    const majorCategory = categoryHierarchy[selectedMajor];
                    for (const middleKey in majorCategory) {
                        const middleCategory = majorCategory[middleKey];
                        for (const smallKey in middleCategory) {
                            industriesToFilter = industriesToFilter.concat(middleCategory[smallKey]);
                        }
                    }
                }
                
                // é‡è¤‡ã‚’é™¤å»
                if (industriesToFilter.length > 0) {
                    industriesToFilter = [...new Set(industriesToFilter)];
                }
                
                if (industriesToFilter.length > 0) {
                    formData.set('industry_filter', industriesToFilter.join(','));
                } else {
                    // ã„ãšã‚Œã‚‚é¸æŠã•ã‚Œã¦ã„ãªã„å ´åˆ: ã™ã¹ã¦ã®æ¥­ç¨®ã‚’å¯¾è±¡
                    formData.set('industry_filter', 'none');
                }
                
                // ãƒšãƒ¼ã‚¸ç•ªå·ã‚’è¿½åŠ 
                formData.set('page', page);
                formData.set('page_size', 10);
                
                console.log('Loading page:', page, 'append:', append);
                
                const response = await fetch('/api/process', {
                    method: 'POST',
                    body: formData,
                    signal: abortController ? abortController.signal : undefined  // ğŸ†• ã‚­ãƒ£ãƒ³ã‚»ãƒ«å¯¾å¿œ
                });
                
                // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®Content-Typeã‚’ç¢ºèª
                const contentType = response.headers.get('content-type');
                console.log('Response status:', response.status);
                console.log('Response content-type:', contentType);
                
                // HTMLãŒè¿”ã£ã¦ããŸå ´åˆï¼ˆã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ï¼‰
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Server returned non-JSON response:', text.substring(0, 500));
                    throw new Error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ãƒ­ã‚°ã‚’ç¢ºèªã—ã¦ãã ã•ã„ / Server error occurred. Please check logs.');
                }
                
                const data = await response.json();
                console.log('Received data:', data);
                console.log('has_next from server:', data.has_next);
                
                if (response.ok) {
                    if (append && currentData) {
                        // ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ 
                        currentData.data = currentData.data.concat(data.data);
                        currentData.total_count += data.total_count;
                        hasNextPage = data.has_next;
                    } else {
                        // æ–°è¦ãƒ‡ãƒ¼ã‚¿
                        currentData = data;
                        hasNextPage = data.has_next;
                    }
                    console.log('Updated hasNextPage:', hasNextPage);
                    displayResults(currentData, append);
                } else {
                    showError(data.error || 'ãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ / Failed to process data');
                }
            } catch (error) {
                showError('é€šä¿¡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ / Communication error occurred: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // URLã‹ã‚‰ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’æŠ½å‡º
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname;
            } catch (e) {
                return url;
            }
        }
        
        // ã‚½ãƒ¼ãƒˆé©ç”¨ã¨è¡¨ç¤ºæ›´æ–°
        function applySortAndDisplay() {
            const sortValue = document.getElementById('sortMetric').value;
            
            if (sortValue === 'none' || !currentData) {
                displayResults(currentData);
                return;
            }
            
            // ã‚½ãƒ¼ãƒˆã‚­ãƒ¼ã¨æ–¹å‘ã‚’æŠ½å‡º
            const [metric, direction] = sortValue.split('_');
            
            // ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã‚½ãƒ¼ãƒˆ
            const sortedData = {
                ...currentData,
                data: [...currentData.data]
            };
            
            // ãƒ‡ãƒãƒƒã‚°: ã‚½ãƒ¼ãƒˆå¯¾è±¡ã®ãƒ¡ãƒˆãƒªãƒƒã‚¯ã¨ãƒ‡ãƒ¼ã‚¿ã®æœ€åˆã®è¡Œã‚’ç¢ºèª
            console.log('Sorting by:', metric, direction);
            console.log('Available columns:', currentData.columns);
            console.log('First row data:', sortedData.data[0]);
            
            sortedData.data.sort((a, b) => {
                let aValue = parseFloat(a[metric]) || 0;
                let bValue = parseFloat(b[metric]) || 0;
                
                // ãƒ‡ãƒãƒƒã‚°: ã‚½ãƒ¼ãƒˆå€¤ã‚’ç¢ºèª
                if (sortedData.data.indexOf(a) < 3) {
                    console.log(`Row ${sortedData.data.indexOf(a)}: ${metric} = ${a[metric]} (parsed: ${aValue})`);
                }
                
                if (direction === 'desc') {
                    return bValue - aValue; // é™é †ï¼ˆé«˜â†’ä½ï¼‰
                } else {
                    return aValue - bValue; // æ˜‡é †ï¼ˆä½â†’é«˜ï¼‰
                }
            });
            
            console.log('Sorted data (first 3 rows):', sortedData.data.slice(0, 3).map(row => ({ 
                url: row.URL, 
                metric: row[metric] 
            })));
            
            displayResults(sortedData);
        }

        // çµæœè¡¨ç¤º
        function displayResults(data, append = false) {
            const resultsDiv = document.getElementById('results');
            const tableHeader = document.getElementById('tableHeader');
            const tableBody = document.getElementById('tableBody');
            const resultCount = document.getElementById('resultCount');
            const loadMoreBtn = document.getElementById('loadMoreBtn');
            const groupByDomain = document.getElementById('groupByDomain').checked;
            
            // åˆ—åã®æ—¥è‹±å¯¾å¿œãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆä¼šç¤¾åã¨ãƒ“ã‚¸ãƒã‚¹åã¯å‰Šé™¤æ¸ˆã¿ï¼‰
            const columnMapping = {
                'ãƒãƒ£ãƒ³ãƒãƒ«å': currentLanguage === 'ja' ? 'ãƒãƒ£ãƒ³ãƒãƒ«å' : 'Channel Name',
                'æ¥­ç¨®': currentLanguage === 'ja' ? 'æ¥­ç¨®' : 'Industry',
                'å›½': currentLanguage === 'ja' ? 'å›½' : 'Country',
                'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ': currentLanguage === 'ja' ? 'ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ' : 'Format',
                'URL': 'URL',
                'VIDEO_VIEWS': currentLanguage === 'ja' ? '3ç§’ä»¥ä¸Šå†ç”ŸUUæ•°' : '3s+ Video Views UU',
                'VIEWTHROUGH_RATE': currentLanguage === 'ja' ? 'ãƒ“ãƒ¥ãƒ¼ã‚¹ãƒ«ãƒ¼UUç‡' : 'View-Through UU Rate',
                'CLICKTHROUGH_RATE': currentLanguage === 'ja' ? 'CTAã‚¯ãƒªãƒƒã‚¯UUç‡' : 'CTA Click UU Rate',
                'A2C_RATE': currentLanguage === 'ja' ? 'ã‚«ãƒ¼ãƒˆè¿½åŠ UUç‡' : 'Add-to-Cart UU Rate',
                'COMPLETION_RATE_25P': currentLanguage === 'ja' ? 'è¦–è´å®Œäº†ç‡25%UUç‡' : '25% Completion UU Rate',
                'COMPLETION_RATE_50P': currentLanguage === 'ja' ? 'è¦–è´å®Œäº†ç‡50%UUç‡' : '50% Completion UU Rate',
                'COMPLETION_RATE_75P': currentLanguage === 'ja' ? 'è¦–è´å®Œäº†ç‡75%UUç‡' : '75% Completion UU Rate',
                'COMPLETION_RATE_100P': currentLanguage === 'ja' ? 'è¦–è´å®Œäº†ç‡100%UUç‡' : '100% Completion UU Rate'
            };
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½œæˆ
            tableHeader.innerHTML = '';
            if (groupByDomain) {
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–æ™‚ã¯å±•é–‹ã‚¢ã‚¤ã‚³ãƒ³åˆ—ã‚’è¿½åŠ 
                const expandTh = document.createElement('th');
                expandTh.className = 'px-2 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                expandTh.textContent = '';
                expandTh.style.width = '30px';
                tableHeader.appendChild(expandTh);
            }
            
            data.columns.forEach(col => {
                const th = document.createElement('th');
                th.className = 'px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider';
                th.textContent = columnMapping[col] || col;
                tableHeader.appendChild(th);
            });
            
            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒœãƒ‡ã‚£ã‚’ä½œæˆï¼ˆè¿½åŠ ãƒ¢ãƒ¼ãƒ‰ã§ãªã„å ´åˆã¯ã‚¯ãƒªã‚¢ï¼‰
            if (!append) {
                tableBody.innerHTML = '';
            }
            
            if (groupByDomain) {
                // Channel Nameã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ï¼ˆå­˜åœ¨ã—ãªã„å ´åˆã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ï¼‰
                const channelGroups = {};
                data.data.forEach(row => {
                    const groupKey = row['ãƒãƒ£ãƒ³ãƒãƒ«å'] || extractDomain(row['URL']);
                    if (!channelGroups[groupKey]) {
                        channelGroups[groupKey] = [];
                    }
                    channelGroups[groupKey].push(row);
                });
                
                // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ãŸãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
                Object.keys(channelGroups).forEach((channelKey, groupIndex) => {
                    const rows = channelGroups[channelKey];
                    
                    // ã‚°ãƒ«ãƒ¼ãƒ—ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
                    const headerTr = document.createElement('tr');
                    headerTr.className = 'domain-group-header';
                    headerTr.dataset.channel = channelKey;
                    
                    // å±•é–‹ã‚¢ã‚¤ã‚³ãƒ³
                    const expandTd = document.createElement('td');
                    expandTd.className = 'px-2 py-2 text-xs text-gray-900';
                    expandTd.innerHTML = '<span class="expand-icon inline-block">â–¶</span>';
                    headerTr.appendChild(expandTd);
                    
                    // å„åˆ—ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å‹•çš„ã«ç”Ÿæˆ
                    data.columns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 text-xs font-semibold text-gray-900';
                        
                        if (col === 'URL') {
                            // è¨€èªã«å¿œã˜ã¦URLä»¶æ•°è¡¨è¨˜ã‚’å¤‰æ›´
                            td.textContent = currentLanguage === 'ja' ? 
                                `(${rows.length}ä»¶ã®URL)` : 
                                `(${rows.length} URL${rows.length !== 1 ? 's' : ''})`;
                        } else if (col === 'ãƒãƒ£ãƒ³ãƒãƒ«å') {
                            td.textContent = channelKey;
                        } else {
                            td.textContent = rows[0][col] || '';
                        }
                        
                        headerTr.appendChild(td);
                    });
                    
                    // åˆè¨ˆè¦–è´å›æ•°ï¼ˆè¡¨ç¤ºã‹ã‚‰é™¤å¤–ï¼‰
                    // const viewsTd = document.createElement('td');
                    // viewsTd.className = 'px-6 py-4 text-sm font-semibold text-gray-900';
                    // viewsTd.textContent = totalViews.toLocaleString();
                    // headerTr.appendChild(viewsTd);
                    
                    // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
                    headerTr.addEventListener('click', function() {
                        const detailRows = document.querySelectorAll(`tr.domain-detail-row[data-channel="${channelKey}"]`);
                        const expandIcon = this.querySelector('.expand-icon');
                        detailRows.forEach(row => row.classList.toggle('expanded'));
                        expandIcon.classList.toggle('expanded');
                    });
                    
                    tableBody.appendChild(headerTr);
                    
                    // è©³ç´°è¡Œï¼ˆå„URLï¼‰
                    rows.forEach((row, rowIndex) => {
                        const detailTr = document.createElement('tr');
                        detailTr.className = 'domain-detail-row';
                        detailTr.dataset.channel = channelKey;
                        
                        // ç©ºã®ã‚»ãƒ«ï¼ˆå±•é–‹ã‚¢ã‚¤ã‚³ãƒ³ã®åˆ—ï¼‰
                        const emptyTd = document.createElement('td');
                        emptyTd.className = 'px-3 py-2';
                        detailTr.appendChild(emptyTd);
                        
                        data.columns.forEach(col => {
                            const td = document.createElement('td');
                            td.className = 'px-3 py-2 text-xs text-gray-700';
                            
                            if (col === 'URL') {
                                const urlContainer = document.createElement('div');
                                urlContainer.className = 'flex items-center gap-2';
                                
                                const link = document.createElement('a');
                                link.href = row[col];
                                link.target = '_blank';
                                link.className = 'text-orange-custom hover:text-orange-600 hover:underline';
                                link.textContent = row[col];
                                
                                const createSlideBtn = document.createElement('button');
                                createSlideBtn.className = 'px-2 py-1 text-xs bg-orange-custom text-white rounded hover:bg-orange-custom';
                                createSlideBtn.textContent = translations.create_slide[currentLanguage];
                                createSlideBtn.setAttribute('data-lang-key', 'create_slide');
                                createSlideBtn.onclick = () => createPptxSlide(row);
                                
                                urlContainer.appendChild(link);
                                urlContainer.appendChild(createSlideBtn);
                                td.appendChild(urlContainer);
                            } else {
                                td.textContent = row[col];
                            }
                            
                            detailTr.appendChild(td);
                        });
                        
                        tableBody.appendChild(detailTr);
                    });
                });
            } else {
                // é€šå¸¸è¡¨ç¤ºï¼ˆã‚°ãƒ«ãƒ¼ãƒ—åŒ–ãªã—ï¼‰
                data.data.forEach((row, index) => {
                    const tr = document.createElement('tr');
                    tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
                    
                    data.columns.forEach(col => {
                        const td = document.createElement('td');
                        td.className = 'px-3 py-2 text-xs text-gray-900';
                        
                        if (col === 'URL') {
                            const urlContainer = document.createElement('div');
                            urlContainer.className = 'flex items-center gap-2';
                            
                            const link = document.createElement('a');
                            link.href = row[col];
                            link.target = '_blank';
                            link.className = 'text-orange-custom hover:text-orange-600 hover:underline';
                            link.textContent = row[col];
                            
                            const createSlideBtn = document.createElement('button');
                            createSlideBtn.className = 'px-2 py-1 text-xs bg-orange-custom text-white rounded hover:bg-orange-custom';
                            createSlideBtn.textContent = translations.create_slide[currentLanguage];
                            createSlideBtn.setAttribute('data-lang-key', 'create_slide');
                            createSlideBtn.onclick = () => createPptxSlide(row);
                            
                            urlContainer.appendChild(link);
                            urlContainer.appendChild(createSlideBtn);
                            td.appendChild(urlContainer);
                        } else {
                            td.textContent = row[col];
                        }
                        
                        tr.appendChild(td);
                    });
                    
                    tableBody.appendChild(tr);
                });
            }
            
            // ä»¶æ•°è¡¨ç¤º
            let totalDomainsText = '';
            if (data.total_domains) {
                if (currentLanguage === 'ja') {
                    totalDomainsText = ` (å…¨${data.total_domains}ãƒ‰ãƒ¡ã‚¤ãƒ³)`;
                } else {
                    totalDomainsText = ` (${data.total_domains} total domains)`;
                }
            }
            
            if (currentLanguage === 'ja') {
                resultCount.textContent = `${data.total_count}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ${totalDomainsText}`;
            } else {
                resultCount.textContent = `${data.total_count} results found${totalDomainsText}`;
            }
            
            // ã€Œæ¬¡ã®10ä»¶ã‚’è¦‹ã‚‹ã€ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºåˆ¶å¾¡
            console.log('hasNextPage:', hasNextPage, 'currentPage:', currentPage);
            if (hasNextPage) {
                loadMoreBtn.classList.remove('hidden');
                loadMoreBtn.style.display = 'block';
            } else {
                loadMoreBtn.classList.add('hidden');
                loadMoreBtn.style.display = 'none';
            }
            
            // çµæœè¡¨ç¤º
            resultsDiv.classList.remove('hidden');
        }
        
        // ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆé–¢æ•°
        async function createPptxSlide(rowData) {
            try {
                showLoading();
                
                const response = await fetch('/api/create-pptx', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        channel_name: rowData['ãƒãƒ£ãƒ³ãƒãƒ«å'] || 'Unknown',
                        industry: rowData['æ¥­ç¨®'],
                        country: rowData['å›½'],
                        url: rowData['URL'],
                        format: rowData['ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ'] || rowData['Format'] || 'Unknown',  // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¿½åŠ 
                        language: currentLanguage,
                        // æ–°ã—ã„æŒ‡æ¨™ã‚’è¿½åŠ 
                        view_through_uu_rate: rowData['VIEWTHROUGH_RATE'] || rowData['View-Through UU Rate'] || 'N/A',
                        cta_click_uu_rate: rowData['CLICKTHROUGH_RATE'] || rowData['CTA Click UU Rate'] || 'N/A',
                        completion_50_uu_rate: rowData['COMPLETION_RATE_50P'] || rowData['50% Completion UU Rate'] || 'N/A'
                    })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    
                    // Content-Dispositionãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«åã‚’å–å¾—
                    const contentDisposition = response.headers.get('Content-Disposition');
                    let filename = `${rowData['ãƒãƒ£ãƒ³ãƒãƒ«å'] || 'Channel'}_Casestudy.pptx`;
                    
                    if (contentDisposition) {
                        // filename*=UTF-8''... å½¢å¼ã‚’ã‚µãƒãƒ¼ãƒˆ
                        const filenameMatch = contentDisposition.match(/filename\*=UTF-8''([^;]+)/);
                        if (filenameMatch) {
                            filename = decodeURIComponent(filenameMatch[1]);
                        } else {
                            // filename="..." å½¢å¼
                            const filenameMatch2 = contentDisposition.match(/filename="?([^";\n]+)"?/);
                            if (filenameMatch2) {
                                filename = filenameMatch2[1];
                            }
                        }
                    }
                    
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    const errorData = await response.json();
                    showError('ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆã‚¨ãƒ©ãƒ¼: ' + errorData.error);
                }
            } catch (error) {
                showError('ã‚¹ãƒ©ã‚¤ãƒ‰ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            } finally {
                hideLoading();
            }
        }

        // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('error').classList.remove('hidden');
        }

        function hideError() {
            document.getElementById('error').classList.add('hidden');
        }

        function hideResults() {
            document.getElementById('results').classList.add('hidden');
        }
    </script>
</body>
</html>
